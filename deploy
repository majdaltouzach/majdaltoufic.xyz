#!/bin/bash

# Load environment variables from .env file
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
else
    echo "Error: .env file not found!"
    echo "Please create a .env file with the following variables:"
    echo "  VPS_USER=your_username"
    echo "  VPS_HOST=your_host_or_ip"
    echo "  VPS_DIR=/path/to/site/directory"
    exit 1
fi

# Check if required variables are set
if [ -z "$VPS_USER" ] || [ -z "$VPS_HOST" ] || [ -z "$VPS_DIR" ]; then
    echo "Error: Missing required environment variables!"
    echo "Please ensure .env file contains:"
    echo "  VPS_USER=your_username"
    echo "  VPS_HOST=your_host_or_ip"
    echo "  VPS_DIR=/path/to/site/directory"
    exit 1
fi

# Build the Hugo site
echo "Building Hugo site..."
hugo

# Check if build was successful
if [ $? -ne 0 ]; then
    echo "Error: Hugo build failed!"
    exit 1
fi

# Deploy to VPS
echo "Deploying to ${VPS_USER}@${VPS_HOST}:${VPS_DIR}"
rsync -arzvh "$PWD/public/" --delete "${VPS_USER}@${VPS_HOST}:${VPS_DIR}"

# Check if deployment was successful
if [ $? -eq 0 ]; then
    echo "Deployment successful!"
else
    echo "Error: Deployment failed!"
    exit 1
fi
